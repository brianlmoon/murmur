{% extends 'admin/layout.html.twig' %}

{% set active_page = 'settings' %}

{% block title %}Settings{% endblock %}

{% block content %}
    <div class="admin-header">
        <h1 class="admin-title">Instance Settings</h1>
    </div>

    {% if error is defined and error %}
        <div class="flash flash-error">
            {{ error }}
        </div>
    {% endif %}

    <div class="card">
        <form action="{{ base_url }}/admin/settings" method="post">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

            <div class="form-group">
                <label for="site_name" class="form-label">Site Name</label>
                <input type="text" id="site_name" name="site_name" class="form-input"
                       value="{{ site_name }}"
                       maxlength="50"
                       required>
                <p style="font-size: 0.75rem; color: var(--color-text-muted); margin-top: 0.25rem;">
                    Displayed in the header and page titles.
                </p>
            </div>

            <div class="form-group">
                <label for="logo_url" class="form-label">Logo URL (optional)</label>
                <input type="url" id="logo_url" name="logo_url" class="form-input"
                       value="{{ logo_url }}"
                       placeholder="https://example.com/logo.png">
                <p style="font-size: 0.75rem; color: var(--color-text-muted); margin-top: 0.25rem;">
                    If set, this image will be displayed in the header instead of the site name.
                </p>
            </div>

            <div class="form-group">
                <label class="form-checkbox">
                    <input type="checkbox" name="registration_open" value="1"
                           {% if registration_open %}checked{% endif %}>
                    <span>Registration open</span>
                </label>
                <p style="font-size: 0.75rem; color: var(--color-text-muted); margin-top: 0.25rem;">
                    When disabled, new users cannot create accounts.
                </p>
            </div>

            <div class="form-group">
                <label class="form-checkbox">
                    <input type="checkbox" name="images_allowed" value="1"
                           {% if images_allowed %}checked{% endif %}>
                    <span>Allow image uploads</span>
                </label>
                <p style="font-size: 0.75rem; color: var(--color-text-muted); margin-top: 0.25rem;">
                    When disabled, users cannot attach images to posts.
                </p>
            </div>

            <div class="form-group">
                <label for="max_attachments" class="form-label">Maximum Attachments per Post</label>
                <input type="number" id="max_attachments" name="max_attachments" class="form-input"
                       value="{{ max_attachments }}"
                       min="1"
                       required>
                <p style="font-size: 0.75rem; color: var(--color-text-muted); margin-top: 0.25rem;">
                    Maximum number of images or videos that can be attached to a single post.
                </p>
            </div>

            <div class="form-group">
                <label class="form-checkbox">
                    <input type="checkbox" name="videos_allowed" value="1"
                           {% if videos_allowed %}checked{% endif %}>
                    <span>Allow video uploads</span>
                </label>
                <p style="font-size: 0.75rem; color: var(--color-text-muted); margin-top: 0.25rem;">
                    When disabled, users cannot attach videos to posts.
                </p>
            </div>

            <div class="form-group">
                <label for="max_video_size_mb" class="form-label">Maximum Video Size (MB)</label>
                <input type="number" id="max_video_size_mb" name="max_video_size_mb" class="form-input"
                       value="{{ max_video_size_mb }}"
                       min="1"
                       max="1000"
                       required>
                <p style="font-size: 0.75rem; color: var(--color-text-muted); margin-top: 0.25rem;">
                    Maximum file size for uploaded videos (1-1000 MB). Requires server configuration for large files.
                </p>
            </div>

            <div class="form-group">
                <label class="form-checkbox">
                    <input type="checkbox" name="require_approval" value="1"
                           {% if require_approval %}checked{% endif %}>
                    <span>Require admin approval for new accounts</span>
                </label>
                <p style="font-size: 0.75rem; color: var(--color-text-muted); margin-top: 0.25rem;">
                    When enabled, new user registrations must be approved by an admin before they can log in.
                </p>
            </div>

            <div class="form-group">
                <label class="form-checkbox">
                    <input type="checkbox" name="public_feed" value="1"
                           {% if public_feed %}checked{% endif %}>
                    <span>Allow public viewing</span>
                </label>
                <p style="font-size: 0.75rem; color: var(--color-text-muted); margin-top: 0.25rem;">
                    When enabled, non-logged-in users can view posts. When disabled, visitors must log in to see content.
                </p>
            </div>

            <div class="form-group">
                <label class="form-checkbox">
                    <input type="checkbox" name="require_topic" value="1"
                           {% if require_topic %}checked{% endif %}
                           {% if topics is empty %}disabled{% endif %}>
                    <span>Require topic selection{% if topics is empty %} (no topics exist){% endif %}</span>
                </label>
                <p style="font-size: 0.75rem; color: var(--color-text-muted); margin-top: 0.25rem;">
                    When enabled, users must select a topic when creating a post.
                    {% if topics is empty %}
                    <a href="{{ base_url }}/admin/topics">Create topics first</a>.
                    {% endif %}
                </p>
            </div>

            <div class="form-group">
                <label class="form-checkbox">
                    <input type="checkbox" name="messaging_enabled" value="1"
                           {% if messaging_enabled %}checked{% endif %}>
                    <span>Enable private messaging</span>
                </label>
                <p style="font-size: 0.75rem; color: var(--color-text-muted); margin-top: 0.25rem;">
                    When enabled, users can send private messages to mutual follows.
                </p>
            </div>

            <div class="form-group">
                <label for="max_post_length" class="form-label">Maximum Post Length</label>
                <input type="number" id="max_post_length" name="max_post_length" class="form-input"
                       value="{{ max_post_length }}"
                       min="100"
                       max="50000"
                       required>
                <p style="font-size: 0.75rem; color: var(--color-text-muted); margin-top: 0.25rem;">
                    Maximum number of characters allowed per post (100 - 50,000).
                </p>
            </div>

            <div class="form-group">
                <label for="theme" class="form-label">Theme</label>
                <select id="theme" name="theme" class="form-input">
                    {% for available_theme in available_themes %}
                        <option value="{{ available_theme }}" {% if theme == available_theme %}selected{% endif %}>
                            {{ available_theme|capitalize }}
                        </option>
                    {% endfor %}
                </select>
                <p style="font-size: 0.75rem; color: var(--color-text-muted); margin-top: 0.25rem;">
                    The visual theme for the user-facing pages.
                </p>
            </div>

            <div class="form-group">
                <label for="locale" class="form-label">Language</label>
                <select id="locale" name="locale" class="form-input">
                    {% for code, name in available_locales %}
                        <option value="{{ code }}" {% if locale == code %}selected{% endif %}>
                            {{ name }}
                        </option>
                    {% endfor %}
                </select>
                <p style="font-size: 0.75rem; color: var(--color-text-muted); margin-top: 0.25rem;">
                    The language for user-facing pages. Add new languages by creating translation files.
                </p>
            </div>

            <h2 style="margin-top: 2rem; margin-bottom: 1rem; font-size: 1.25rem;">OAuth Providers</h2>
            <p style="color: var(--color-text-muted); margin-bottom: 1rem;">
                Enable OAuth sign-in providers. Configuration credentials must be set in <code>etc/config.ini</code>.
            </p>

            {% for provider_name, status in oauth_providers %}
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" name="oauth_{{ provider_name }}_enabled" value="1"
                               {% if status.enabled %}checked{% endif %}
                               {% if not status.configured %}disabled{% endif %}>
                        <span>{{ provider_name|capitalize }}</span>
                        {% if not status.configured %}
                            <span style="color: var(--color-error); font-size: 0.875rem;">(Not Configured)</span>
                        {% else %}
                            <span style="color: var(--color-success); font-size: 0.875rem;">(Configured)</span>
                        {% endif %}
                    </label>
                </div>
            {% endfor %}

            <button type="submit" class="btn btn-primary">Save Settings</button>
        </form>
    </div>
{% endblock %}
