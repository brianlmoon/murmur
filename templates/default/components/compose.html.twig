{#
    Compose form component - form for creating posts or replies

    Variables:
    - action: Form action URL
    - csrf_token: CSRF token (from base)
    - max_length: Maximum body length
    - placeholder: Placeholder text (optional)
    - button_text: Submit button text (optional, default "Post")
    - autofocus: Whether to focus the textarea (optional, default false)
    - topics: Array of Topic entities (optional, for top-level posts only)
    - require_topic: Whether topic selection is required (optional, default false)
    - is_reply: Whether this is a reply form (optional, default false)
#}
{% set placeholder = placeholder | default("What's on your mind?") %}
{% set button_text = button_text | default("Post") %}
{% set autofocus = autofocus | default(false) %}
{% set form_id = form_id | default('') %}
{% set is_reply = is_reply | default(false) %}
{% set require_topic = require_topic | default(false) %}

<form action="{{ action }}" method="post" enctype="multipart/form-data" class="compose-form"{% if form_id %} id="{{ form_id }}"{% endif %}>
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

    {% if not is_reply and topics is defined and topics is not empty %}
    <div class="compose-topic">
        <select name="topic_id" class="compose-topic-select"{% if require_topic %} required{% endif %}>
            {% if not require_topic %}
            <option value="">Select a topic (optional)</option>
            {% else %}
            <option value="">Select a topic</option>
            {% endif %}
            {% for topic in topics %}
            <option value="{{ topic.topic_id }}">{{ topic.name }}</option>
            {% endfor %}
        </select>
    </div>
    {% endif %}

    <div class="compose-body">
        <textarea name="body" class="compose-textarea"
                  placeholder="{{ placeholder }}"
                  maxlength="{{ max_length }}"
                  required{{ autofocus ? ' autofocus' : '' }}></textarea>
        <div class="compose-counter">
            <span class="compose-counter-current">0</span>/<span>{{ max_length }}</span>
        </div>
    </div>

    <div class="compose-footer">
        {% if images_allowed %}
        <label class="compose-upload">
            <input type="file" name="image" accept="image/jpeg,image/png,image/gif,image/webp" class="compose-file">
            <span class="compose-upload-label">Add image</span>
        </label>
        {% else %}
        <span></span>
        {% endif %}
        <button type="submit" class="btn btn-primary">{{ button_text }}</button>
    </div>

    {% if images_allowed %}
    <div class="compose-preview" style="display: none;">
        <img src="" alt="Preview" class="compose-preview-img">
        <button type="button" class="compose-preview-remove">&times;</button>
    </div>
    {% endif %}
</form>

<script>
(function() {
    const form = document.currentScript.previousElementSibling;
    const textarea = form.querySelector('.compose-textarea');
    const counter = form.querySelector('.compose-counter-current');
    const fileInput = form.querySelector('.compose-file');
    const preview = form.querySelector('.compose-preview');
    const previewImg = form.querySelector('.compose-preview-img');
    const removeBtn = form.querySelector('.compose-preview-remove');

    textarea.addEventListener('input', function() {
        counter.textContent = this.value.length;
    });

    if (fileInput && preview && previewImg && removeBtn) {
        fileInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(this.files[0]);
            }
        });

        removeBtn.addEventListener('click', function() {
            fileInput.value = '';
            preview.style.display = 'none';
            previewImg.src = '';
        });
    }

    // Scroll to form if #reply hash is present
    if (form.id && window.location.hash === '#' + form.id) {
        window.addEventListener('load', function() {
            setTimeout(function() {
                form.scrollIntoView({ behavior: 'smooth', block: 'center' });
                textarea.focus();
            }, 500);
        });
    }
})();
</script>
