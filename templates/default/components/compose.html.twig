{#
    Compose form component - form for creating posts or replies

    Variables:
    - action: Form action URL
    - csrf_token: CSRF token (from base)
    - max_length: Maximum body length
    - max_attachments: Maximum attachments allowed (optional, from global)
    - placeholder: Placeholder text (optional)
    - button_text: Submit button text (optional, default "Post")
    - autofocus: Whether to focus the textarea (optional, default false)
    - topics: Array of Topic entities (optional, for top-level posts only)
    - require_topic: Whether topic selection is required (optional, default false)
    - is_reply: Whether this is a reply form (optional, default false)
#}
{% set placeholder = placeholder | default("What's on your mind?") %}
{% set button_text = button_text | default("Post") %}
{% set autofocus = autofocus | default(false) %}
{% set form_id = form_id | default('') %}
{% set is_reply = is_reply | default(false) %}
{% set require_topic = require_topic | default(false) %}
{% set selected_topic_id = selected_topic_id | default(null) %}
{% set max_attachments = max_attachments | default(10) %}

<form action="{{ action }}" method="post" enctype="multipart/form-data" class="compose-form"{% if form_id %} id="{{ form_id }}"{% endif %} data-max-attachments="{{ max_attachments }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

    {% if not is_reply and topics is defined and topics is not empty %}
    <div class="compose-topic">
        <select name="topic_id" class="compose-topic-select"{% if require_topic %} required{% endif %}>
            {% if not require_topic %}
            <option value="">Select a topic (optional)</option>
            {% else %}
            <option value="">Select a topic</option>
            {% endif %}
            {% for topic in topics %}
            <option value="{{ topic.topic_id }}"{% if selected_topic_id == topic.topic_id %} selected{% endif %}>{{ topic.name }}</option>
            {% endfor %}
        </select>
    </div>
    {% endif %}

    <div class="compose-body">
        <textarea name="body" class="compose-textarea"
                  placeholder="{{ placeholder }}"
                  maxlength="{{ max_length }}"
                  required{{ autofocus ? ' autofocus' : '' }}></textarea>
        <div class="compose-counter">
            <span class="compose-counter-current">0</span>/<span>{{ max_length }}</span>
        </div>
    </div>

    <div class="compose-footer">
        {% if images_allowed %}
        <label class="compose-upload">
            <input type="file" name="images[]" accept="image/jpeg,image/png,image/gif,image/webp" class="compose-file" multiple>
            <span class="compose-upload-label">Add images</span>
            <span class="compose-upload-count"></span>
        </label>
        {% else %}
        <span></span>
        {% endif %}
        <button type="submit" class="btn btn-primary">{{ button_text }}</button>
    </div>

    {% if images_allowed %}
    <div class="compose-previews"></div>
    {% endif %}
</form>

<script>
(function() {
    const form = document.currentScript.previousElementSibling;
    const textarea = form.querySelector('.compose-textarea');
    const counter = form.querySelector('.compose-counter-current');
    const fileInput = form.querySelector('.compose-file');
    const previewsContainer = form.querySelector('.compose-previews');
    const uploadCount = form.querySelector('.compose-upload-count');
    const maxAttachments = parseInt(form.dataset.maxAttachments) || 10;

    textarea.addEventListener('input', function() {
        counter.textContent = this.value.length;
    });

    if (fileInput && previewsContainer) {
        fileInput.addEventListener('change', function() {
            previewsContainer.innerHTML = '';
            
            if (this.files && this.files.length > 0) {
                const fileCount = this.files.length;
                
                if (fileCount > maxAttachments) {
                    uploadCount.textContent = ' (' + fileCount + '/' + maxAttachments + ' - too many!)';
                    uploadCount.style.color = 'var(--color-error, #dc2626)';
                } else {
                    uploadCount.textContent = ' (' + fileCount + '/' + maxAttachments + ')';
                    uploadCount.style.color = '';
                }
                
                Array.from(this.files).forEach(function(file, index) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const previewItem = document.createElement('div');
                        previewItem.className = 'compose-preview-item';
                        
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.alt = 'Preview ' + (index + 1);
                        img.className = 'compose-preview-img';
                        
                        previewItem.appendChild(img);
                        previewsContainer.appendChild(previewItem);
                    };
                    reader.readAsDataURL(file);
                });
            } else {
                uploadCount.textContent = '';
            }
        });
    }

    // Prevent form submission if too many files selected
    form.addEventListener('submit', function(e) {
        if (fileInput && fileInput.files && fileInput.files.length > maxAttachments) {
            e.preventDefault();
            alert('Please select no more than ' + maxAttachments + ' images. You have selected ' + fileInput.files.length + '.');
            return false;
        }
    });

    // Scroll to form if #reply hash is present
    if (form.id && window.location.hash === '#' + form.id) {
        window.addEventListener('load', function() {
            setTimeout(function() {
                form.scrollIntoView({ behavior: 'smooth', block: 'center' });
                textarea.focus();
            }, 500);
        });
    }
})();
</script>
