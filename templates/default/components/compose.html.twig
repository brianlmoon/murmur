{#
    Compose form component - form for creating posts or replies

    Variables:
    - action: Form action URL
    - csrf_token: CSRF token (from base)
    - max_length: Maximum body length
    - max_attachments: Maximum attachments allowed (optional, from global)
    - placeholder: Placeholder text (optional)
    - button_text: Submit button text (optional, default "Post")
    - autofocus: Whether to focus the textarea (optional, default false)
    - topics: Array of Topic entities (optional, for top-level posts only)
    - require_topic: Whether topic selection is required (optional, default false)
    - is_reply: Whether this is a reply form (optional, default false)
#}
{% set placeholder = placeholder | default('compose.placeholder'|trans) %}
{% set button_text = button_text | default('compose.post_button'|trans) %}
{% set autofocus = autofocus | default(false) %}
{% set form_id = form_id | default('') %}
{% set is_reply = is_reply | default(false) %}
{% set require_topic = require_topic | default(false) %}
{% set selected_topic_id = selected_topic_id | default(null) %}
{% set max_attachments = max_attachments | default(10) %}

<form action="{{ action }}" method="post" enctype="multipart/form-data" class="compose-form"{% if form_id %} id="{{ form_id }}"{% endif %} data-max-attachments="{{ max_attachments }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

    {% if not is_reply and topics is defined and topics is not empty %}
    <div class="compose-topic">
        <select name="topic_id" class="compose-topic-select"{% if require_topic %} required{% endif %}>
            {% if not require_topic %}
            <option value="">{{ 'compose.topic_select_optional'|trans }}</option>
            {% else %}
            <option value="">{{ 'compose.topic_select_required'|trans }}</option>
            {% endif %}
            {% for topic in topics %}
            <option value="{{ topic.topic_id }}"{% if selected_topic_id == topic.topic_id %} selected{% endif %}>{{ topic.name }}</option>
            {% endfor %}
        </select>
    </div>
    {% endif %}

    <div class="compose-body">
        <textarea name="body" class="compose-textarea"
                  placeholder="{{ placeholder }}"
                  maxlength="{{ max_length }}"
                  required{{ autofocus ? ' autofocus' : '' }}></textarea>
        <div class="compose-counter">
            <span class="compose-counter-current">0</span>/<span>{{ max_length }}</span>
        </div>
    </div>

    <div class="compose-footer">
        {% if images_allowed or videos_allowed %}
        <label class="compose-upload">
            <input type="file" name="media[]" accept="{% if images_allowed %}image/jpeg,image/png,image/gif,image/webp{% endif %}{% if images_allowed and videos_allowed %},{% endif %}{% if videos_allowed %}video/mp4,video/webm{% endif %}" class="compose-file" multiple>
            <span class="compose-upload-label">{{ 'compose.add_media'|trans }}</span>
            <span class="compose-upload-count"></span>
        </label>
        {% else %}
        <span></span>
        {% endif %}
        <button type="submit" class="btn btn-primary">{{ button_text }}</button>
    </div>

    {% if images_allowed or videos_allowed %}
    <div class="compose-previews"></div>
    <div class="compose-progress" style="display: none;">
        <div class="compose-progress-bar"></div>
        <span class="compose-progress-text">0%</span>
    </div>
    <div class="compose-error"></div>
    {% endif %}
</form>

<script>
(function() {
    const form = document.currentScript.previousElementSibling;
    const textarea = form.querySelector('.compose-textarea');
    const counter = form.querySelector('.compose-counter-current');
    const fileInput = form.querySelector('.compose-file');
    const previewsContainer = form.querySelector('.compose-previews');
    const uploadCount = form.querySelector('.compose-upload-count');
    const errorContainer = form.querySelector('.compose-error');
    const progressContainer = form.querySelector('.compose-progress');
    const progressBar = form.querySelector('.compose-progress-bar');
    const progressText = form.querySelector('.compose-progress-text');
    const maxAttachments = parseInt(form.dataset.maxAttachments) || 10;

    textarea.addEventListener('input', function() {
        counter.textContent = this.value.length;
    });

    if (fileInput && previewsContainer) {
        fileInput.addEventListener('change', function() {
            previewsContainer.innerHTML = '';
            if (errorContainer) {
                errorContainer.style.display = 'none';
                errorContainer.textContent = '';
            }
            
            if (this.files && this.files.length > 0) {
                const fileCount = this.files.length;
                
                if (fileCount > maxAttachments) {
                    uploadCount.textContent = ` (${fileCount}/${maxAttachments} - too many!)`;
                    uploadCount.style.color = 'var(--color-error, #dc2626)';
                } else {
                    uploadCount.textContent = ` (${fileCount}/${maxAttachments})`;
                    uploadCount.style.color = '';
                }
                
                Array.from(this.files).forEach(function(file, index) {
                    const previewItem = document.createElement('div');
                    previewItem.className = 'compose-preview-item';
                    
                    if (file.type.startsWith('video/')) {
                        // Video preview
                        const video = document.createElement('video');
                        video.src = URL.createObjectURL(file);
                        video.className = 'compose-preview-video';
                        video.muted = true;
                        video.preload = 'metadata';
                        previewItem.appendChild(video);
                    } else {
                        // Image preview
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const img = document.createElement('img');
                            img.src = e.target.result;
                            img.alt = `Preview ${index + 1}`;
                            img.className = 'compose-preview-img';
                            previewItem.appendChild(img);
                        };
                        reader.readAsDataURL(file);
                    }
                    
                    previewsContainer.appendChild(previewItem);
                });
            } else {
                uploadCount.textContent = '';
            }
        });
    }

    // Handle form submission with progress
    const submitBtn = form.querySelector('button[type="submit"]');
    let isSubmitting = false;

    form.addEventListener('submit', function(e) {
        // Debounce: prevent double submission
        if (isSubmitting) {
            e.preventDefault();
            return;
        }

        // Check if too many files selected
        if (fileInput && fileInput.files && fileInput.files.length > maxAttachments) {
            e.preventDefault();
            if (errorContainer) {
                errorContainer.textContent = `Please select no more than ${maxAttachments} files. You have selected ${fileInput.files.length}.`;
                errorContainer.style.display = 'block';
                errorContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
            return;
        }

        // Only use AJAX upload with progress bar if files are selected
        const hasFiles = fileInput && fileInput.files && fileInput.files.length > 0;
        
        if (!hasFiles) {
            // No files selected, allow normal form submission
            return;
        }

        // Use AJAX upload with progress bar
        e.preventDefault();

        // Disable button to prevent double-clicks
        isSubmitting = true;
        if (submitBtn) {
            submitBtn.disabled = true;
        }

        const xhr = new XMLHttpRequest();
        const formData = new FormData(form);

        // Show progress bar
        if (progressContainer) {
            progressContainer.style.display = 'block';
            progressBar.style.width = '0%';
            progressText.textContent = '0%';
        }

        // Hide error
        if (errorContainer) {
            errorContainer.style.display = 'none';
        }

        xhr.upload.addEventListener('progress', function(e) {
            if (e.lengthComputable && progressBar && progressText) {
                const percent = Math.round((e.loaded / e.total) * 100);
                progressBar.style.width = percent + '%';
                progressText.textContent = percent + '%';
            }
        });

        xhr.addEventListener('load', function() {
            if (xhr.status === 200) {
                try {
                    const response = JSON.parse(xhr.responseText);
                    if (response.success && response.redirect) {
                        window.location.href = response.redirect;
                    } else if (response.error) {
                        if (errorContainer) {
                            errorContainer.textContent = response.error;
                            errorContainer.style.display = 'block';
                        }
                        if (progressContainer) {
                            progressContainer.style.display = 'none';
                        }
                        // Re-enable button on error
                        isSubmitting = false;
                        if (submitBtn) {
                            submitBtn.disabled = false;
                        }
                    } else {
                        // Non-JSON response, likely a redirect - follow it
                        window.location.reload();
                    }
                } catch (e) {
                    // Not JSON, probably a redirect page
                    window.location.reload();
                }
            } else {
                if (errorContainer) {
                    errorContainer.textContent = 'Upload failed. Please try again.';
                    errorContainer.style.display = 'block';
                }
                if (progressContainer) {
                    progressContainer.style.display = 'none';
                }
                // Re-enable button on error
                isSubmitting = false;
                if (submitBtn) {
                    submitBtn.disabled = false;
                }
            }
        });

        xhr.addEventListener('error', function() {
            if (errorContainer) {
                errorContainer.textContent = 'Upload failed. Please try again.';
                errorContainer.style.display = 'block';
            }
            if (progressContainer) {
                progressContainer.style.display = 'none';
            }
            // Re-enable button on error
            isSubmitting = false;
            if (submitBtn) {
                submitBtn.disabled = false;
            }
        });

        xhr.open('POST', form.action);
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
        xhr.send(formData);
    });

    // Scroll to form if #reply hash is present
    if (form.id && window.location.hash === '#' + form.id) {
        window.addEventListener('load', function() {
            setTimeout(function() {
                form.scrollIntoView({ behavior: 'smooth', block: 'center' });
                textarea.focus();
            }, 500);
        });
    }
})();
</script>
